<div id="19e38f5e-e176-41e1-bbe5-f5a8ba3a93cb" class="cell markdown"
data-tags="[]" data-toc-hr-collapsed="true">
<h1 id="example-using-pellet-sorter">Example using pellet sorter</h1>
<p>This notebook contains an example of how to run the code for
collecting the material. Most cells can be run without any modification
if the collector has been built without design modifications. The lines
that need modifications are markedlike this:</p>
<p><code>###############################################################################################################</code></p>
</div>
<div id="1d69f4e7-b199-45a2-80d9-b7098a7648af" class="cell code">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import Libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> serial</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> serial.tools.list_ports</span></code></pre></div>
</div>
<div id="f081979b-8b2c-4d96-9bfe-04dcdac16372" class="cell markdown">
<p>In this cell, we define the port name for the arduino and the
balance. We do it by listing the connected ports and selecting the ones
whose device serial is the corresponding to our device. You should find
the serial of your devices and change it accordingly. You can do it by
inspecting the devices detected by serial.tools.list_ports.comports().
In case of doubt, try disconnecting and connecting to see which ports
are affected.</p>
</div>
<div id="b82084df-b333-4aaa-88f8-334ee537c9c9" class="cell code"
data-tags="[]">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ports <span class="op">=</span> serial.tools.list_ports.comports()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">###############################################################################################################</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>arduino_serial <span class="op">=</span> <span class="st">&quot;write_here_your_arduino_serial&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>balance_serial <span class="op">=</span> <span class="st">&quot;write_here_your_balance_serial&quot;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">###############################################################################################################</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> port <span class="kw">in</span> ports:</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> port.serial_number <span class="op">==</span> arduino_serial:</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        arduino_port <span class="op">=</span> port.device</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> port.serial_number <span class="op">==</span> balance_serial:</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        balance_port <span class="op">=</span> port.device</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">### Serial initialization</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">## Arduino</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>arduino <span class="op">=</span> serial.Serial(arduino_port, <span class="dv">9600</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">## Balance</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>balance <span class="op">=</span> serial.Serial(balance_port, <span class="dv">9600</span>)</span></code></pre></div>
</div>
<div id="ea865003-6e50-4c00-bc6a-42515e340794" class="cell markdown">
<p>We import the functions from the pellet_sorter.py script. Note: you
need to install the <code>ikpy</code> library</p>
</div>
<div id="3c6928a7-0a55-4c9a-874c-23846b2c5700" class="cell code"
data-tags="[]">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pellet_sorter <span class="im">as</span> ps</span></code></pre></div>
</div>
<div id="2ff30808-4e27-4caa-95a7-064b3281fb2d" class="cell markdown">
<p>Define the capacity of the cup in kg</p>
</div>
<div id="4c541ce3-2520-41d0-95a9-04e4375af43c" class="cell code">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">###############################################################################################################</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>cup_capacity <span class="op">=</span> <span class="fl">0.16</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">###############################################################################################################</span></span></code></pre></div>
</div>
<div id="e35d4280-3f85-418d-8fd9-f369e0b78080" class="cell markdown">
<p>The next cell defines a series of parameters needed for the
calculations. They don't have to be modified unless you have modified
something in the design.</p>
</div>
<div id="a68ab2e7-9c1c-4c00-8168-6efa344e02e0" class="cell code"
data-tags="[]">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Initializations</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># sorter_chain, sorter_parameters and arduino should be global variables</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>n_joints <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>sorter_parameters <span class="op">=</span> [{<span class="st">&#39;steps_in_rotation&#39;</span>:<span class="dv">0</span>,<span class="st">&#39;gear_ratio&#39;</span>:<span class="dv">0</span>,<span class="st">&#39;length_mm&#39;</span>:<span class="dv">0</span>,<span class="st">&#39;bound_rad&#39;</span>:<span class="dv">0</span>, <span class="st">&#39;cartesian&#39;</span>:[<span class="dv">0</span>,<span class="dv">0</span>]} <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(n_joints)]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">## Top</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">0</span>][<span class="st">&#39;steps_in_rotation&#39;</span>] <span class="op">=</span> np.<span class="bu">round</span>(<span class="dv">200</span><span class="op">*</span><span class="fl">1.1</span>)   <span class="co"># Calibrate multiplicative factor to compensate lost steps if necessary</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">0</span>][<span class="st">&#39;gear_ratio&#39;</span>] <span class="op">=</span> <span class="dv">6</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">0</span>][<span class="st">&#39;length_mm&#39;</span>] <span class="op">=</span> <span class="fl">180.5</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">0</span>][<span class="st">&#39;bound_rad&#39;</span>] <span class="op">=</span> np.deg2rad(<span class="dv">35</span>)    <span class="co"># np.deg2rad(35)  # IK Rotation bound in either direction, not total</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">0</span>][<span class="st">&#39;cartesian&#39;</span>] <span class="op">=</span> [sorter_parameters[<span class="dv">0</span>].get(<span class="st">&#39;length_mm&#39;</span>), <span class="dv">0</span>]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">## Bot</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">1</span>][<span class="st">&#39;steps_in_rotation&#39;</span>] <span class="op">=</span> <span class="dv">812</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">1</span>][<span class="st">&#39;gear_ratio&#39;</span>] <span class="op">=</span> <span class="fl">2.4</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">1</span>][<span class="st">&#39;length_mm&#39;</span>] <span class="op">=</span> np.sqrt(<span class="fl">32.7</span><span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="fl">79.2</span><span class="op">**</span><span class="dv">2</span>)  <span class="co"># 84.4</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">1</span>][<span class="st">&#39;bound_rad&#39;</span>] <span class="op">=</span> np.deg2rad(<span class="dv">10</span><span class="op">*</span><span class="dv">360</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>sorter_parameters[<span class="dv">1</span>][<span class="st">&#39;cartesian&#39;</span>] <span class="op">=</span> [sorter_parameters[<span class="dv">1</span>].get(<span class="st">&#39;length_mm&#39;</span>), <span class="dv">0</span>]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Positions of the cups in the tray</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>tray_1 <span class="op">=</span> ps.Tray(<span class="st">&#39;1&#39;</span>, [sorter_parameters[<span class="dv">0</span>][<span class="st">&#39;length_mm&#39;</span>], <span class="dv">0</span>], [</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="fl">79.2</span>,<span class="fl">32.7</span>]),</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="fl">32.7</span>,<span class="fl">79.2</span>]),</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="op">-</span><span class="fl">32.7</span>,<span class="fl">79.2</span>]),</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="op">-</span><span class="fl">79.2</span>,<span class="fl">32.7</span>]),</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="op">-</span><span class="fl">79.2</span>,<span class="op">-</span><span class="fl">32.7</span>]),</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="op">-</span><span class="fl">32.7</span>,<span class="op">-</span><span class="fl">79.2</span>]),</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="fl">32.7</span>,<span class="op">-</span><span class="fl">79.2</span>]),</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="fl">79.2</span>,<span class="op">-</span><span class="fl">32.7</span>]),</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    ps.Slot([<span class="dv">0</span>,<span class="dv">0</span>]), </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>tray_1.fill_all_slots_ez(<span class="dv">0</span>, cup_capacity)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>tray_1.set_all_material(<span class="st">&#39;PLA####&#39;</span>)</span></code></pre></div>
</div>
<div id="dfc6c2ac-5daa-4422-93b6-80a30d0dc5e3" class="cell markdown">
<p>In the next cell, we use the Arduino Command Line Interface
(arduino-cli) to compile and upload the arduino script. If you prefer to
do it using the Graphical User Interface, skip this cell. For using it,
update the location of your arduino-cli</p>
</div>
<div id="344f84b8-970c-4ba8-9676-7b3b308142be" class="cell code"
data-tags="[]">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">###############################################################################################################</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">&quot;/PATH/arduino-cli compile --fqbn arduino:avr:uno ../../Arduino/Pellet_sorter_v2/Pellet_sorter_v2.ino&quot;</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st">&quot;/PATH/arduino-cli upload -p &quot;</span><span class="op">+</span>arduino_port<span class="op">+</span><span class="st">&quot; --fqbn arduino:avr:uno ../../Arduino/Pellet_sorter_v2/Pellet_sorter_v2.ino&quot;</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">###############################################################################################################</span></span></code></pre></div>
</div>
<div id="b76fca03-62a1-4394-9a13-3dcbc95e1d4f" class="cell markdown">
<p>The <code>fill_tray</code> function will run all the process. It uses
the objects defined in the previous steps. The three parameters that
allow interesting customization are:</p>
<p><code>:param seq: List with the order of filling of the cups. If None, they will all be filled in default order</code></p>
<p><code>:param purge_slot: Number of the slot used for purging. This slot can be left without cup so the material is discarded. Used when changing material. If None, no purging will be done.</code></p>
<p><code>:param purge_time: Time for purge in minutes. Default: 0</code></p>
<p>If <code>seq = None</code> and <code>purge_slot = None</code>, the
cups will be filled sequentially (from 0 to 8) without any purging.</p>
<p>If <code>purge_slot</code> is not None, like
<code>purge_slot = 0</code> for example, that hole will be used for
purging. That hole should be left empty (without cup), and the tray
should be in some kind of box or container so the pellets are not
spilled everywhere. In that case, if seq is None the purging will be
made after each cup, so the cup 1 will be filled, then purge, then cup
2, then purge, etc.</p>
<p>For more detailed control, you can use <code>seq</code>. For example,
if you want cups 1 and 2 filled with one material and cups 3 and 4 with
another, you can use <code>purge_slot = 0</code> and
<code>seq = [1,2,0,3,4,0]</code>. In this way, after filling cups 1 and
2 with the same material it will make a purge in slot 0, and the fill
cups 3 and 4.</p>
</div>
<div id="c45eef8b-e721-4868-a3fc-e8b8e844b95a" class="cell code"
data-tags="[]">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">##################################################################################################################</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>ps.fill_tray(tray_1, sorter_parameters, arduino, balance, seq <span class="op">=</span> <span class="va">None</span>, purge_slot <span class="op">=</span> <span class="dv">0</span>, purge_time <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">###############################################################################################################</span></span></code></pre></div>
</div>
<div id="391da3ff-5614-4f19-b5ab-da1dc9a2c451" class="cell markdown">
<p>NOTE: As an alternative, you can use <code>fill_tray_SIMULATED</code>
to check if the filling order is the desired</p>
</div>
<div id="6d6d6e36-af2d-4eb7-b45d-e25b097335db" class="cell code">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ps.fill_tray_SIMULATED(tray_1, sorter_parameters, seq <span class="op">=</span> <span class="va">None</span>, purge_slot <span class="op">=</span> <span class="dv">7</span>, purge_time <span class="op">=</span> <span class="dv">1</span>)</span></code></pre></div>
</div>
<div id="286d6bd8-e0ae-4699-9c65-ab9fb57dc871" class="cell code">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
</div>
